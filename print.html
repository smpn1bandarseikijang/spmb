<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak Data SPMB - SMPN 1 Bandar Seikijang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            color: #000;
        }
        
        /* Pengaturan Khusus Kertas A4 & Print */
        @page {
            size: A4 landscape; /* Mendatar agar kolom muat banyak */
            margin: 15mm;
        }

        @media print {
            body { 
                background-color: #fff; 
            }
            .print-hidden { 
                display: none !important; 
            }
            .page-break-avoid {
                page-break-inside: avoid;
            }
            .a4-container {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            table {
                font-size: 10px; /* Ukuran font dikecilkan saat diprint agar muat 1 lembar */
            }
            th {
                background-color: #f3f4f6 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
        }

        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6;
            width: 24px; height: 24px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Tombol Print & Kembali (Disembunyikan saat di-print) -->
    <div class="print-hidden fixed top-6 right-6 flex space-x-3 z-50">
        <a href="admin.html" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg shadow-lg font-medium transition flex items-center">
            <i class="fas fa-arrow-left mr-2"></i> Kembali
        </a>
        <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow-lg font-bold transition flex items-center">
            <i class="fas fa-print mr-2"></i> Cetak A4
        </button>
    </div>

    <!-- Alert Jika Belum Login -->
    <div id="auth-alert" class="hidden text-center mt-20 print-hidden">
        <i class="fas fa-lock text-5xl text-red-500 mb-4"></i>
        <h2 class="text-2xl font-bold">Akses Ditolak</h2>
        <p class="text-gray-600 mt-2 mb-4">Anda harus login sebagai Admin untuk melihat halaman ini.</p>
        <a href="admin.html" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium">Ke Halaman Login</a>
    </div>

    <!-- Kertas A4 (Container Utama) -->
    <div id="print-area" class="a4-container bg-white mx-auto max-w-6xl p-8 rounded-xl shadow-xl hidden">
        
        <!-- Header Laporan -->
        <div class="text-center border-b-2 border-black pb-4 mb-6">
            <h1 class="text-2xl font-bold uppercase tracking-wide">Laporan Data Pendaftar SPMB</h1>
            <h2 class="text-xl font-bold uppercase tracking-wide">SMP Negeri 1 Bandar Seikijang</h2>
            <p class="text-sm mt-1">Tahun Ajaran 2026/2027</p>
            <p class="text-xs text-gray-600 mt-1">Dicetak pada: <span id="print-date"></span></p>
        </div>

        <!-- Tabel Data -->
        <table class="w-full border-collapse border border-gray-300 text-xs text-left">
            <thead>
                <tr class="bg-gray-100 border border-gray-300 uppercase tracking-wider">
                    <th class="border border-gray-300 px-2 py-2 text-center w-8">No</th>
                    <th class="border border-gray-300 px-2 py-2">NISN / Nama Pendaftar</th>
                    <th class="border border-gray-300 px-2 py-2 text-center">L/P</th>
                    <th class="border border-gray-300 px-2 py-2">Asal SD</th>
                    <th class="border border-gray-300 px-2 py-2">Jalur</th>
                    <th class="border border-gray-300 px-2 py-2 text-right">Nilai</th>
                    <th class="border border-gray-300 px-2 py-2 text-right">Jarak</th>
                    <th class="border border-gray-300 px-2 py-2">No. HP</th>
                    <th class="border border-gray-300 px-2 py-2">Waktu Daftar</th>
                </tr>
            </thead>
            <tbody id="print-tabel-body">
                <tr><td colspan="9" class="text-center py-10"><div class="loader mx-auto"></div><p class="mt-2">Memuat data...</p></td></tr>
            </tbody>
        </table>

        <!-- Tanda Tangan -->
        <div class="mt-12 flex justify-end">
            <div class="text-center w-64">
                <p class="text-sm mb-16">Bandar Seikijang, ...................... 2026</p>
                <p class="text-sm font-bold">Panitia SPMB</p>
                <div class="border-b border-black mt-16"></div>
                <p class="text-xs mt-1">NIP. ........................................</p>
            </div>
        </div>

    </div>

    <!-- FIREBASE & LOGIC SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // ==============================================================================
        // KONFIGURASI FIREBASE REALTIME DATABASE 
        // ==============================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCeOhSar2LoSsR1hArXk_CUQuxpbxIkDQI",
            authDomain: "spmb-508e3.firebaseapp.com",
            databaseURL: "https://spmb-508e3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "spmb-508e3",
            storageBucket: "spmb-508e3.firebasestorage.app",
            messagingSenderId: "915422129101",
            appId: "1:915422129101:web:a93838926952ccc1f9b284"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Set Tanggal Cetak Otomatis
        document.getElementById('print-date').innerText = new Date().toLocaleDateString('id-ID', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' 
        });

        // Cek Login Admin
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-alert').classList.add('hidden');
                document.getElementById('print-area').classList.remove('hidden');
                loadDataPrint();
            } else {
                document.getElementById('auth-alert').classList.remove('hidden');
                document.getElementById('print-area').classList.add('hidden');
            }
        });

        function loadDataPrint() {
            const pendaftarRef = ref(db, 'pendaftar');
            onValue(pendaftarRef, (snapshot) => {
                const data = snapshot.val();
                let allData = [];
                
                if (data) {
                    for (let id in data) {
                        allData.push(data[id]);
                    }
                }
                
                // Urutkan berdasarkan Nama (A-Z) agar rapi saat diprint
                allData.sort((a, b) => (a.nama || '').localeCompare(b.nama || ''));
                renderTable(allData);
            });
        }

        function renderTable(dataArray) {
            const tbody = document.getElementById('print-tabel-body');
            tbody.innerHTML = '';

            if(dataArray.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center py-4 italic">Belum ada data pendaftar.</td></tr>`;
                return;
            }

            dataArray.forEach((p, index) => {
                let tglStr = "-";
                if(p.waktu_daftar) {
                    const d = new Date(p.waktu_daftar);
                    tglStr = `${('0'+d.getDate()).slice(-2)}/${('0'+(d.getMonth()+1)).slice(-2)}/${d.getFullYear()}`;
                }

                let displayNilai = new Intl.NumberFormat('id-ID').format(p.nilai || 0);
                let jkSingkat = p.jenis_kelamin === 'Laki-laki' ? 'L' : (p.jenis_kelamin === 'Perempuan' ? 'P' : '-');

                // page-break-avoid mencegah baris terbelah dua saat ganti kertas
                tbody.innerHTML += `
                    <tr class="page-break-avoid hover:bg-gray-50">
                        <td class="border border-gray-300 px-2 py-1.5 text-center">${index + 1}</td>
                        <td class="border border-gray-300 px-2 py-1.5">
                            <span class="font-bold">${p.nama || '-'}</span><br>
                            <span class="font-mono text-gray-600 text-[10px]">${p.nisn || '-'}</span>
                        </td>
                        <td class="border border-gray-300 px-2 py-1.5 text-center">${jkSingkat}</td>
                        <td class="border border-gray-300 px-2 py-1.5">${p.asal_sekolah || '-'}</td>
                        <td class="border border-gray-300 px-2 py-1.5">${p.jalur || '-'}</td>
                        <td class="border border-gray-300 px-2 py-1.5 text-right font-medium">${displayNilai}</td>
                        <td class="border border-gray-300 px-2 py-1.5 text-right font-medium">${p.jarak_km || 0} Km</td>
                        <td class="border border-gray-300 px-2 py-1.5">${p.hp_siswa || '-'}</td>
                        <td class="border border-gray-300 px-2 py-1.5 text-xs text-gray-600">${tglStr}</td>
                    </tr>
                `;
            });
        }
    </script>
</body>
</html>
