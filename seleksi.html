<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seleksi Pendaftar - SPMB SMPN 1 Bandar Seikijang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f6f9; }
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6;
            width: 24px; height: 24px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Animasi Toast Notifikasi */
        #toast { transition: opacity 0.3s, transform 0.3s; }
        .toast-show { opacity: 1; transform: translateY(0); }
        .toast-hide { opacity: 0; transform: translateY(20px); pointer-events: none; }
    </style>
</head>
<body class="text-gray-800 h-screen flex overflow-hidden">

    <!-- Overlay untuk mobile sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="admin-sidebar" class="w-64 bg-gray-900 text-white flex flex-col fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 z-50 transition-transform duration-300 h-full shadow-2xl md:shadow-none">
        <div class="h-16 flex items-center justify-between px-6 border-b border-gray-800">
            <div class="flex items-center">
                <i class="fas fa-graduation-cap text-yellow-500 text-2xl mr-3"></i>
                <span class="font-bold text-lg tracking-wider">SPMB ADMIN</span>
            </div>
            <button class="md:hidden text-gray-400 hover:text-white" onclick="toggleSidebar()">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="flex-grow overflow-y-auto py-4">
            <ul class="space-y-1">
                <li>
                    <a href="admin.html" class="flex items-center px-6 py-3 text-gray-400 hover:text-white hover:bg-gray-800 transition">
                        <i class="fas fa-tachometer-alt w-6"></i> Dashboard
                    </a>
                </li>
                <li>
                    <a href="admin.html" class="flex items-center px-6 py-3 text-gray-400 hover:text-white hover:bg-gray-800 transition">
                        <i class="fas fa-users w-6"></i> Data Pendaftar
                    </a>
                </li>
                <!-- Menu Seleksi Aktif -->
                <li>
                    <a href="#" class="flex items-center px-6 py-3 bg-blue-800 text-white border-l-4 border-blue-500">
                        <i class="fas fa-tasks w-6"></i> Seleksi
                    </a>
                </li>
                <li>
                    <a href="print.html" target="_blank" class="flex items-center px-6 py-3 text-purple-400 hover:text-purple-300 hover:bg-gray-800 transition">
                        <i class="fas fa-print w-6"></i> Cetak Formulir
                    </a>
                </li>
            </ul>
        </div>
        <div class="p-4 border-t border-gray-800">
            <button id="btn-logout" class="flex items-center text-gray-400 hover:text-red-400 transition w-full">
                <i class="fas fa-sign-out-alt w-6"></i> Keluar
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-full overflow-hidden w-full relative">
        <!-- Topbar -->
        <header class="h-16 bg-white shadow-sm flex items-center justify-between px-4 sm:px-6 z-10 w-full shrink-0">
            <div class="flex items-center">
                <button class="md:hidden text-gray-600 hover:text-blue-600 focus:outline-none mr-4" onclick="toggleSidebar()">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h2 class="text-lg sm:text-xl font-semibold text-gray-800 truncate">Proses Seleksi Pendaftar</h2>
            </div>
            <div class="flex items-center">
                <span class="text-sm text-gray-600 mr-4 hidden sm:block">Admin Akses</span>
                <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto p-4 sm:p-6 bg-gray-100">
            
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col">
                <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                    <p class="text-sm text-gray-600 mb-4"><i class="fas fa-info-circle text-blue-500 mr-1"></i> Urutan otomatis: <b>Domisili</b> diurutkan dari jarak terdekat. Jalur lainnya diurutkan dari nilai tertinggi.</p>
                    
                    <div class="flex flex-col sm:flex-row items-center gap-3 w-full">
                        <!-- Dropdown Filter Jalur -->
                        <select id="filter-jalur" class="w-full sm:w-48 px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium text-gray-700">
                            <option value="Semua Jalur">Semua Jalur</option>
                            <option value="Domisili" selected>Domisili</option>
                            <option value="Prestasi">Prestasi</option>
                            <option value="Afirmasi">Afirmasi</option>
                            <option value="Mutasi">Mutasi</option>
                        </select>
                        
                        <div class="relative w-full sm:w-64">
                            <input type="text" id="search-ranking" placeholder="Cari Nama / NISN..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                        </div>
                        
                        <div class="ml-auto bg-white border border-gray-300 px-3 py-1.5 rounded-lg text-sm font-semibold text-gray-700 shadow-sm" id="total-pendaftar">
                            Total: 0
                        </div>
                    </div>
                </div>
                
                <div class="table-container overflow-x-auto p-0">
                    <table class="w-full text-left border-collapse whitespace-nowrap min-w-[900px]">
                        <thead>
                            <tr class="bg-white text-gray-500 text-xs uppercase tracking-wider border-b-2 border-gray-200">
                                <th class="p-4 w-12 text-center">#</th>
                                <th class="p-4">NISN</th>
                                <th class="p-4">Nama Siswa</th>
                                <th class="p-4">Asal Sekolah</th>
                                <th class="p-4">Jalur</th>
                                <th class="p-4 text-right">Nilai RP</th>
                                <th class="p-4 text-right">TKA</th>
                                <th class="p-4 text-right">Jarak</th>
                                <th class="p-4 text-center w-48">Status Seleksi</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-body" class="text-sm">
                            <tr><td colspan="9" class="text-center py-10"><div class="loader mx-auto"></div><p class="text-gray-500 mt-2">Memuat data dari Firebase...</p></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="p-4 border-t border-gray-200 flex items-center justify-between bg-white rounded-b-lg">
                    <span class="text-sm text-gray-600" id="page-info">Menampilkan 0 data</span>
                    <div class="flex space-x-2">
                        <button id="btn-prev-page" class="px-3 py-1 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 disabled:opacity-50 transition"><i class="fas fa-chevron-left"></i></button>
                        <button id="btn-next-page" class="px-3 py-1 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 disabled:opacity-50 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
            
            <p class="text-xs text-gray-400 text-center mt-6 mb-2">Developed by Andri F. &copy; 2026 SMPN 1 Bandar Seikijang.</p>
        </main>
    </div>

    <!-- Alert Modal / Login Auth Guard -->
    <div id="auth-alert" class="fixed inset-0 z-[100] bg-gray-900 bg-opacity-90 hidden flex-items-center justify-center p-4 flex">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full mx-auto text-center mt-20">
            <i class="fas fa-lock text-5xl text-red-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Akses Ditolak</h2>
            <p class="text-gray-600 mb-6">Anda harus login sebagai Admin untuk mengakses halaman seleksi ini.</p>
            <a href="admin.html" class="block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition">Ke Halaman Login</a>
        </div>
    </div>

    <!-- Toast Notification untuk Sukses Simpan -->
    <div id="toast" class="fixed bottom-6 right-6 z-50 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl flex items-center toast-hide">
        <i class="fas fa-check-circle text-green-400 text-xl mr-3"></i>
        <span id="toast-msg" class="font-medium">Status berhasil diperbarui</span>
    </div>

    <!-- FIREBASE & LOGIC SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // ==============================================================================
        // KONFIGURASI FIREBASE REALTIME DATABASE 
        // ==============================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCeOhSar2LoSsR1hArXk_CUQuxpbxIkDQI",
            authDomain: "spmb-508e3.firebaseapp.com",
            databaseURL: "https://spmb-508e3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "spmb-508e3",
            storageBucket: "spmb-508e3.firebasestorage.app",
            messagingSenderId: "915422129101",
            appId: "1:915422129101:web:a93838926952ccc1f9b284"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let allData = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let searchQuery = '';
        let filterJalur = 'Domisili'; // Default Domisili

        // ==============================================================================
        // 0. UI INTERACTIVITY
        // ==============================================================================
        window.toggleSidebar = function() {
            document.getElementById('admin-sidebar').classList.toggle('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.toggle('hidden');
        };

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('toast-hide');
            toast.classList.add('toast-show');
            setTimeout(() => {
                toast.classList.remove('toast-show');
                toast.classList.add('toast-hide');
            }, 2500);
        }

        // ==============================================================================
        // 1. AUTHENTICATION GUARD
        // ==============================================================================
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-alert').classList.add('hidden');
                document.getElementById('auth-alert').classList.remove('flex');
                loadDataSeleksi();
            } else {
                document.getElementById('auth-alert').classList.remove('hidden');
                document.getElementById('auth-alert').classList.add('flex');
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => {
            if(confirm("Apakah Anda yakin ingin keluar?")) {
                signOut(auth).then(() => { window.location.href = "admin.html"; });
            }
        });

        // ==============================================================================
        // 2. LOAD & RENDER TABLE 
        // ==============================================================================
        function loadDataSeleksi() {
            const pendaftarRef = ref(db, 'pendaftar');
            onValue(pendaftarRef, (snapshot) => {
                const data = snapshot.val();
                allData = [];
                if (data) {
                    for (let id in data) {
                        allData.push({ firebase_id: id, ...data[id] });
                    }
                }
                renderTable();
            });
        }

        function renderTable() {
            const tbody = document.getElementById('tabel-body');
            const totalSpan = document.getElementById('total-pendaftar');
            const pageInfo = document.getElementById('page-info');
            const btnPrev = document.getElementById('btn-prev-page');
            const btnNext = document.getElementById('btn-next-page');

            // Filtering
            let filtered = allData.filter(p => {
                let matchJalur = false;
                if (filterJalur === 'Semua Jalur') matchJalur = true;
                else if (filterJalur === 'Domisili' && p.jalur === 'Domisili') matchJalur = true;
                else if (filterJalur === 'Prestasi' && p.jalur === 'Prestasi') matchJalur = true;
                else if (filterJalur === 'Afirmasi' && p.jalur && p.jalur.includes('Afirmasi')) matchJalur = true;
                else if (filterJalur === 'Mutasi' && p.jalur === 'Mutasi') matchJalur = true;

                let matchSearch = true;
                if (searchQuery) {
                    const q = searchQuery.toLowerCase();
                    matchSearch = (p.nama && p.nama.toLowerCase().includes(q)) || (p.nisn && p.nisn.includes(q));
                }
                return matchJalur && matchSearch;
            });

            // Sorting
            filtered.sort((a, b) => {
                if (filterJalur === 'Domisili' || (filterJalur === 'Semua Jalur' && a.jalur === 'Domisili' && b.jalur === 'Domisili')) {
                    return (a.jarak_km || 0) - (b.jarak_km || 0); // Jarak terkecil di atas
                }
                return (b.nilai || 0) - (a.nilai || 0); // Nilai terbesar di atas
            });

            totalSpan.innerText = `Total: ${filtered.length}`;

            // Pagination
            const totalPages = Math.ceil(filtered.length / itemsPerPage) || 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = filtered.slice(startIndex, endIndex);

            pageInfo.innerText = `Menampilkan ${filtered.length === 0 ? 0 : startIndex + 1}-${Math.min(endIndex, filtered.length)} dari ${filtered.length} pendaftar`;
            
            btnPrev.disabled = currentPage === 1;
            btnNext.disabled = currentPage === totalPages || filtered.length === 0;

            // Render
            if (paginatedItems.length > 0) {
                tbody.innerHTML = '';
                let no = startIndex + 1;
                paginatedItems.forEach(p => {
                    let colorJalur = p.jalur === 'Domisili' ? 'blue' : (p.jalur === 'Prestasi' ? 'green' : (p.jalur === 'Mutasi' ? 'red' : 'purple'));
                    let displayNilai = new Intl.NumberFormat('id-ID').format(p.nilai || 0);
                    let displayTKA = p.nilai_tka ? new Intl.NumberFormat('id-ID').format(p.nilai_tka) : '-';

                    // Logika Styling Tombol Switch
                    let status = p.status_seleksi || '';
                    let btnTerimaClass = status === 'Diterima' ? 'bg-green-500 text-white shadow-inner scale-95 border-green-600' : 'bg-white text-gray-500 hover:bg-green-50 border-gray-200';
                    let btnTolakClass = status === 'Ditolak' ? 'bg-red-500 text-white shadow-inner scale-95 border-red-600' : 'bg-white text-gray-500 hover:bg-red-50 border-gray-200';

                    tbody.innerHTML += `
                        <tr class="hover:bg-blue-50 border-b border-gray-100 transition ${status === 'Ditolak' ? 'bg-red-50/30' : (status === 'Diterima' ? 'bg-green-50/30' : '')}">
                            <td class="p-4 font-bold text-center text-gray-500">${no++}</td>
                            <td class="p-4 font-mono text-gray-800">${p.nisn || '-'}</td>
                            <td class="p-4 font-bold text-gray-900">${p.nama || '-'}</td>
                            <td class="p-4 text-gray-600 text-xs">${p.asal_sekolah || '-'}</td>
                            <td class="p-4"><span class="px-2 py-1 bg-${colorJalur}-100 text-${colorJalur}-800 rounded text-xs font-semibold">${p.jalur || '-'}</span></td>
                            <td class="p-4 font-bold text-gray-700 text-right">${displayNilai}</td>
                            <td class="p-4 font-bold text-gray-700 text-right">${displayTKA}</td>
                            <td class="p-4 text-gray-600 text-right">${p.jarak_km || 0} Km</td>
                            <td class="p-4 text-center">
                                <div class="inline-flex rounded-md shadow-sm" role="group">
                                    <button type="button" onclick="setSeleksi('${p.firebase_id}', 'Diterima', '${status}')" class="px-3 py-1.5 text-xs font-bold border rounded-l-lg transition-all ${btnTerimaClass}">
                                        <i class="fas fa-check mr-1"></i> Terima
                                    </button>
                                    <button type="button" onclick="setSeleksi('${p.firebase_id}', 'Ditolak', '${status}')" class="px-3 py-1.5 text-xs font-bold border-y border-r rounded-r-lg transition-all ${btnTolakClass}">
                                        <i class="fas fa-times mr-1"></i> Tolak
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center py-8 text-gray-500">Pendaftar tidak ditemukan.</td></tr>`;
            }
        }

        // Listener Filter
        document.getElementById('filter-jalur').addEventListener('change', (e) => {
            filterJalur = e.target.value;
            currentPage = 1; 
            renderTable();
        });

        document.getElementById('search-ranking').addEventListener('input', (e) => {
            searchQuery = e.target.value;
            currentPage = 1; 
            renderTable();
        });
        
        document.getElementById('btn-prev-page').addEventListener('click', () => {
            if(currentPage > 1) { currentPage--; renderTable(); }
        });
        document.getElementById('btn-next-page').addEventListener('click', () => {
            currentPage++; renderTable();
        });

        // ==============================================================================
        // 3. FUNGSI UPDATE STATUS SELEKSI KE FIREBASE
        // ==============================================================================
        window.setSeleksi = async function(firebaseId, clickedStatus, currentStatus) {
            try {
                // Jika tombol yang sama diklik 2x, maka reset status (Batal seleksi)
                let newStatus = clickedStatus;
                if (currentStatus === clickedStatus) {
                    newStatus = null; // Menghapus field status
                }

                const dbRef = ref(db, 'pendaftar/' + firebaseId);
                await update(dbRef, { status_seleksi: newStatus });
                
                if(newStatus) {
                    showToast(`Siswa ditetapkan sebagai: ${newStatus}`);
                } else {
                    showToast(`Status seleksi direset.`);
                }
            } catch (error) {
                console.error("Gagal update status seleksi:", error);
                alert("Gagal menyimpan perubahan. Periksa koneksi internet Anda.");
            }
        };

    </script>
</body>
</html>
